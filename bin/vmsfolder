#!/usr/bin/env bash
# Author: Bruno Guimarães
# Description: Mount a VM shared folder (current session only)
# Version: 1.1
# Last Updated: 2026-01-08

set -euo pipefail
IFS=$'\n\t'

# ──────────────────────────────────────────────────────────────────────────────
# Functions
# ──────────────────────────────────────────────────────────────────────────────
ensure_args() {
  if [[ $# -ne 2 ]]; then
    echo "Usage: vmsfolder <source_folder> <destination_folder>" >&2
    exit 1
  fi
}

ensure_mountpoint() {
  local dest="$1"
  if [[ ! -d "$dest" ]]; then
    mkdir -p "$dest"
  fi
}

is_mounted() {
  local dest="$1"
  mountpoint -q "$dest"
}

mount_shared() {
  local source="$1"
  local dest="$2"

  if is_mounted "$dest"; then
    logi "Already mounted: $dest"
    return 0
  fi

  logi "Mounting '$source' → '$dest'"

  if [[ "$EUID" -eq 0 ]]; then
    mount -t 9p -o trans=virtio "$source" "$dest"
  else
    sudo mount -t 9p -o trans=virtio "$source" "$dest"
  fi
}

# ──────────────────────────────────────────────────────────────────────────────
# Main
# ──────────────────────────────────────────────────────────────────────────────
main() {
  ensure_args "$@"

  local source_folder="$1"
  local destination_folder="$2"

  ensure_mountpoint "$destination_folder"
  mount_shared "$source_folder" "$destination_folder"

  logs "Folder successfully mounted"
}

# ──────────────────────────────────────────────────────────────────────────────
# Entry Point
# ──────────────────────────────────────────────────────────────────────────────
[[ "${BASH_SOURCE[0]}" == "${0}" ]] && main "$@"
