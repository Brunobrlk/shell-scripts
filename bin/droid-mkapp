#!/usr/bin/env bash
# Author: Bruno Guimarães
# Description:
# Version: 1.0
# Last Updated: 2025-12-09

set -euo pipefail
IFS=$'\n\t'

logi() { printf '\033[0;34m[BRLK INFO]\033[0m - %s\n' "$1"; }
logs() { printf '\033[0;32m[BRLK SUCCESS]\033[0m - %s\n' "$1"; }

# ──────────────────────────────────────────────────────────────────────────────
# Constants / Config
# ──────────────────────────────────────────────────────────────────────────────
readonly SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")/.." && pwd)"
readonly PROJECT_DIR="${1:-$(pwd)}"
readonly MAIN_DIR="$PROJECT_DIR/app/src/main"
readonly PKG=$(grep 'namespace' "$PROJECT_DIR/app/build.gradle.kts" | sed -E 's/.*"([^"]+)".*/\1/')
readonly PKG_DIR=$(printf "%s" "$PKG" | tr '.' '/')
readonly MODULE_DIR="$MAIN_DIR/java/$PKG_DIR"
readonly ACTIVITY_CODE_TEMPLATE="$SCRIPT_DIR/templates/android/MainActivity.kt"
readonly ACTIVITY_XML_TEMPLATE="$SCRIPT_DIR/templates/android/activity_main.xml"
readonly FRAGMENT_CODE_TEMPLATE="$SCRIPT_DIR/templates/android/HomeFragment.kt"
readonly FRAGMENT_XML_TEMPLATE="$SCRIPT_DIR/templates/android/fragment_home.xml"
readonly RESOURCES_TEMPLATE="$SCRIPT_DIR/templates/android/resources.xml"
readonly NAVIGATION_TEMPLATE="$SCRIPT_DIR/templates/android/navigation.xml"

# ──────────────────────────────────────────────────────────────────────────────
# Functions
# ──────────────────────────────────────────────────────────────────────────────
setup_architecture(){
  local module_dir="$1"
  local main_dir="${module_dir%/java/*}"

  mkdir -p "$module_dir/core/di" "$module_dir/core/startup" "$module_dir/core/lifecycle" "$module_dir/core/utils"
  mkdir -p "$module_dir/data/remote/services" "$module_dir/data/remote/utils" "$module_dir/data/remote/dtos" "$module_dir/data/mappers" "$module_dir/data/mediators"
  mkdir -p "$module_dir/data/local/database/daos" "$module_dir/data/local/database/entities" "$module_dir/data/local/database/utils" 
  mkdir -p "$module_dir/domain/models" "$module_dir/domain/repository"
  mkdir -p "$module_dir/ui"
  mkdir -p "$main_dir/res/navigation"
  logi "Architecture created: /core, /data(local, remote, mappers), /ui, /domain"
}

add_main_activity(){
  local module_dir="$1"

  local old_main_activity="$module_dir/MainActivity.kt"
  [[ -f "$old_main_activity" ]] && rm "$old_main_activity"

  local pkg=$(printf '%s' "${module_dir#*/java/}" | tr '/' '.')
  local code_template="$2"
  local target_file="$module_dir/ui/MainActivity.kt"
  env PKG="$pkg" envsubst <"$code_template" >"$target_file"

  # Add xml layout
  local xml_template="$3"
  local main_dir="${module_dir%/java/*}"
  cp "$xml_template" "$main_dir/res/layout"

  logi "Activity added: $xml_template"
}

add_fragment(){
  local module_dir="$1"

  local pkg=$(printf '%s' "${module_dir#*/java/}" | tr '/' '.')
  local code_template="$2"
  local target_file="$module_dir/ui/HomeFragment.kt"
  env PKG="$pkg" envsubst <"$code_template" >"$target_file"

  local xml_template="$3"
  local main_dir="${module_dir%/java/*}"
  cp "$xml_template" "$main_dir/res/layout"

  logi "Fragment added: $xml_template"
}

add_navigation(){
  local main_dir="$1"
  local template="$2"
  mkdir -p "$main_dir/res/navigation"
  cp "$template" "$main_dir/res/navigation"

  logi "Navigation added: $template"
}

add_resource() {
  local values_file="$1"
  local template="$2"
  local sample_value="$3"
  cp "$template" "$values_file"
  sed -i "/<application/ a\    $sample_value" "$values_file"

  logi "Resource created: $values_file"
}

# ──────────────────────────────────────────────────────────────────────────────
# Main
# ──────────────────────────────────────────────────────────────────────────────
main() {
  setup_architecture "$MODULE_DIR"
  "$SCRIPT_DIR/bin/droid-appclass" "$PROJECT_DIR"
  "$SCRIPT_DIR/bin/droid-vb" "$PROJECT_DIR"
  add_main_activity "$MODULE_DIR" "$ACTIVITY_CODE_TEMPLATE" "$ACTIVITY_XML_TEMPLATE"
  add_fragment "$MODULE_DIR" "$FRAGMENT_CODE_TEMPLATE" "$FRAGMENT_XML_TEMPLATE"
  add_navigation "$MAIN_DIR" "$NAVIGATION_TEMPLATE"
  add_resource "$MAIN_DIR/res/values/strings_accessibility.xml" "$RESOURCES_TEMPLATE" '<string name="desc_x">x</string>'
  add_resource "$MAIN_DIR/res/values/strings_actions.xml" "$RESOURCES_TEMPLATE" '<string name="action_x">x</string>'
  add_resource "$MAIN_DIR/res/values/strings_errors.xml" "$RESOURCES_TEMPLATE" '<string name="error_x">x</string>'
  add_resource "$MAIN_DIR/res/values/strings_labels.xml" "$RESOURCES_TEMPLATE" '<string name="label_x">x</string>'
  add_resource "$MAIN_DIR/res/values/strings_titles.xml" "$RESOURCES_TEMPLATE" '<string name="title_x">x</string>'
  add_resource "$MAIN_DIR/res/values/strings_messages.xml" "$RESOURCES_TEMPLATE" '<string name="msg_x">x</string>'
  add_resource "$MAIN_DIR/res/values/text_appearance.xml" "$RESOURCES_TEMPLATE" '<style name="" parent=""></style>'
  add_resource "$MAIN_DIR/res/values/dimens.xml" "$RESOURCES_TEMPLATE" '<dimen name="">16dp</dimen>'

  logs "Initial app structure successfully created"
}

# ──────────────────────────────────────────────────────────────────────────────
# Entry Point
# ──────────────────────────────────────────────────────────────────────────────
# Only run main if script is executed (not sourced)
[[ "${BASH_SOURCE[0]}" == "${0}" ]] && main "$@"
