#!/usr/bin/env bash
# Author: Bruno Guimarães
# Description:
# Version: 1.0
# Last Updated: 2026-01-07

set -euo pipefail
IFS=$'\n\t'

# ──────────────────────────────────────────────────────────────────────────────
# Constants / Config
# ──────────────────────────────────────────────────────────────────────────────
declare -A MENU=(
  ["$option_1"]="bash -c 'mpc toggle -q; notify-send -u low -t 1000 \"  \$(mpc current)\"'"
  [""]="mpc stop -q"
  [""]="bash -c 'mpc prev -q; notify-send -u low -t 1000 \"  \$(mpc current)\"'"
  [""]="bash -c 'mpc next -q; notify-send -u low -t 1000 \"  \$(mpc current)\"'"
  [""]="mpc repeat -q"
  [""]="mpc random -q"
)

# ──────────────────────────────────────────────────────────────────────────────
# Functions
# ──────────────────────────────────────────────────────────────────────────────
# Rofi CMD
rofi_cmd() {
  local prompt="$1"
  local mesg="$2"
  local active="$3"
  local urgent="$4"

  # Import Theme
  type="$HOME/.config/rofi/applets/type-2"
  style='style-3.rasi'
  theme="$type/$style"

  # Theme Elements
  list_col='6'
  list_row='1'

  rofi -theme-str "listview {columns: $list_col; lines: $list_row;}" \
    -theme-str 'textbox-prompt-colon {str: "";}' \
    -dmenu \
    -p "$prompt" \
    -mesg "$mesg" \
    ${active} ${urgent} \
    -markup-rows \
    -theme ${theme}
}

# ──────────────────────────────────────────────────────────────────────────────
# Main
# ──────────────────────────────────────────────────────────────────────────────
main() {
  # Get MPD status
  local status="$(mpc status)"
  local prompt
  local mesg
  local option_1
  local active=''
  local urgent=''

  if [[ -z "$status" ]]; then
    prompt='Offline'
    mesg="MPD is Offline"
  else
    prompt="$(mpc -f "%artist%" current)"
    mesg="$(mpc -f "%title%" current) :: $(mpc status | grep "#" | awk '{print $3}')"
  fi

  # Choose icon based on whether MPD is playing
  if [[ $status == *"[playing]"* ]]; then
    option_1="" # pause icon
  else
    option_1="" # play icon
  fi

  # Toggle Actions
  ## Repeat
  if [[ ${status} == *"repeat: on"* ]]; then
    active="-a 4"
  elif [[ ${status} == *"repeat: off"* ]]; then
    urgent="-u 4"
  fi

  ## Random
  if [[ ${status} == *"random: on"* ]]; then
    [ -n "$active" ] && active+=",5" || active="-a 5"
  elif [[ ${status} == *"random: off"* ]]; then
    [ -n "$urgent" ] && urgent+=",5" || urgent="-u 5"
  fi

  local order=("$option_1" "" "" "" "" "")

  local choice=$(printf "%s\n" "${order[@]}" | rofi_cmd "$prompt" "$mesg" "$active" "$urgent")
  [[ -z "$choice" ]] && exit 0

  eval "${MENU[$choice]}"
}

# ──────────────────────────────────────────────────────────────────────────────
# Entry Point
# ──────────────────────────────────────────────────────────────────────────────
# Only run main if script is executed (not sourced)
[[ "${BASH_SOURCE[0]}" == "${0}" ]] && main "$@"
