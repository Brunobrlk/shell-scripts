#!/usr/bin/env bash
# Author: Bruno GuimarÃ£es
# Description: Add permission to android apps via rofi
# Version: 1.0
# Last Updated: 2026-01-02

set -euo pipefail
IFS=$'\n\t'

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Constants / Config
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Import Rofi Theme
readonly SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")/.." && pwd)"
source "$SCRIPT_DIR/lib/rofi-theme.sh"

readonly PROJECT_DIR="${1:-$(pwd)}"
readonly MANIFEST_FILE="$PROJECT_DIR/app/src/main/AndroidManifest.xml"
readonly VALUES_FOLDER="$PROJECT_DIR/app/src/main/res/values"
readonly MSGS_FILE="$VALUES_FOLDER/strings_messages.xml"
readonly TITLES_FILE="$VALUES_FOLDER/strings_titles.xml"
readonly LIB_CHOICES=(
  "ğŸ“· Camera"
  "ğŸ“ Location"
  "ğŸ’¾ Storage"
  "ğŸŒ Internet"
  "ğŸ™ï¸ Microphone"
  "ğŸ“ Phone"
  "ğŸ‘¥ Contacts"
  "ğŸ”” Notifications"
  "ğŸ“¶ Bluetooth"
  "ğŸ“¡ NFC"
  "ğŸ§­ Sensors"
  "âš¡ Wake Lock"
)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Functions
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
add_resource_line() {
  local file_path="$1"
  local line="$2"

  # 1. Create file with default content if it doesn't exist
  if [ ! -f "$file_path" ]; then
    envsubst <"$SCRIPT_DIR/templates/android/resources.xml" >"$file_path"
  fi

  # 2. Insert the line before </resources> with 4 spaces indentation
  sed -i "/<\/resources>/ i\    $line" "$file_path"
}

add_manifest_permission() {
  local manifest_file="$1"
  local perm_str="$2"

  # Insert the line before </resources> with 4 spaces indentation
  sed -i "/<application/ i\    <uses-permission android:name=\"android\.permission\.$perm_str\"\/>" "$manifest_file"
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Main
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
main() {
  local choice=$(printf "%s\n" "${LIB_CHOICES[@]}" | rofi_cmd)
  [[ -z "$choice" ]] && exit 0
  choice="${choice##* }"

  case "$choice" in
  "Camera")
    add_resource_line $TITLES_FILE "<string name=\"title_camera_permission\">Camera Permission</string>"
    add_resource_line $MSGS_FILE "<string name=\"msg_camera_permission\">The app needs camera permission to take photos.</string>"
    add_manifest_permission "$MANIFEST_FILE" "CAMERA"
    ;;

  "Location")
    add_resource_line $TITLES_FILE "<string name=\"title_location_permission\">Location Permission</string>"
    add_resource_line $MSGS_FILE "<string name=\"msg_location_permission\">The app needs location permission to provide location-based services.</string>"
    add_manifest_permission "$MANIFEST_FILE" "ACCESS_FINE_LOCATION"
    add_manifest_permission "$MANIFEST_FILE" "ACCESS_COARSE_LOCATION"
    ;;

  "Storage")
    add_resource_line $TITLES_FILE "<string name=\"title_storage_permission\">Storage Permission</string>"
    add_resource_line $MSGS_FILE "<string name=\"msg_storage_permission\">The app needs storage permission to read and save files.</string>"
    add_manifest_permission "$MANIFEST_FILE" "READ_EXTERNAL_STORAGE"
    add_manifest_permission "$MANIFEST_FILE" "WRITE_EXTERNAL_STORAGE"
    ;;

  "Internet")
    add_manifest_permission "$MANIFEST_FILE" "INTERNET"
    add_manifest_permission "$MANIFEST_FILE" "ACCESS_NETWORK_STATE"
    ;;

  "Microphone")
    add_resource_line $TITLES_FILE "<string name=\"title_microphone_permission\">Microphone Permission</string>"
    add_resource_line $MSGS_FILE "<string name=\"msg_microphone_permission\">The app needs microphone permission to record audio.</string>"
    add_manifest_permission "$MANIFEST_FILE" "RECORD_AUDIO"
    ;;

  "Phone")
    add_resource_line $TITLES_FILE "<string name=\"title_phone_permission\">Phone Permission</string>"
    add_resource_line $MSGS_FILE "<string name=\"msg_phone_permission\">The app needs phone permission to manage calls.</string>"
    add_manifest_permission "$MANIFEST_FILE" "READ_PHONE_STATE"
    ;;

  "Contacts")
    add_resource_line $TITLES_FILE "<string name=\"title_contacts_permission\">Contacts Permission</string>"
    add_resource_line $MSGS_FILE "<string name=\"msg_contacts_permission\">The app needs contacts permission to access your contacts.</string>"
    add_manifest_permission "$MANIFEST_FILE" "READ_CONTACTS"
    add_manifest_permission "$MANIFEST_FILE" "WRITE_CONTACTS"
    ;;

  "Notifications")
    add_resource_line $TITLES_FILE "<string name=\"title_notification_permission\">Notification Permission</string>"
    add_resource_line $MSGS_FILE "<string name=\"msg_notification_permission\">The app needs permission to send notifications.</string>"
    add_manifest_permission "$MANIFEST_FILE" "POST_NOTIFICATIONS"
    ;;

  "Bluetooth")
    add_manifest_permission "$MANIFEST_FILE" "BLUETOOTH"
    add_manifest_permission "$MANIFEST_FILE" "BLUETOOTH_CONNECT"
    add_manifest_permission "$MANIFEST_FILE" "BLUETOOTH_SCAN"
    ;;

  "NFC")
    add_manifest_permission "$MANIFEST_FILE" "NFC"
    ;;

  "Sensors")
    add_manifest_permission "$MANIFEST_FILE" "BODY_SENSORS"
    ;;

  "Wake")
    add_manifest_permission "$MANIFEST_FILE" "WAKE_LOCK"
    ;;
  esac
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Entry Point
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Only run main if script is executed (not sourced)
[[ "${BASH_SOURCE[0]}" == "${0}" ]] && main "$@"
