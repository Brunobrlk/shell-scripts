#!/usr/bin/env bash
# Author: Bruno Guimarães
# Description:
# Version: 1.0
# Last Updated: 2026-01-06

set -euo pipefail
IFS=$'\n\t'

logi() { printf '\033[0;34m[BRLK INFO]\033[0m - %s\n' "$1"; }
logs() { printf '\033[0;32m[BRLK SUCCESS]\033[0m - %s\n' "$1"; }

# ──────────────────────────────────────────────────────────────────────────────
# Constants / Config
# ──────────────────────────────────────────────────────────────────────────────
readonly PROJECT_DIR="$1"

# ──────────────────────────────────────────────────────────────────────────────
# Functions
# ──────────────────────────────────────────────────────────────────────────────
ensure_args() {
  if [ $# -ne 1 ]; then
    echo "Usage: $(basename "$0") <PROJECT_PATH>" >&2
    return 1
  fi
}

zip_native_symbols(){
  local project_dir="$1"

  # Paths
  local symbols_dir="${project_dir}/app/build/intermediates/merged_native_libs/release/mergeReleaseNativeLibs/out/lib"
  local output_dir="${project_dir}/app/release"

  # Dynamic filename (date-based)
  local date_str=$(date +%Y%m%d)
  local output_zip="${output_dir}/zip_symbols_${date_str}.zip"

  # Ensure the symbols directory exists
  if [[ ! -d "$symbols_dir" ]]; then
    loge "Error: Symbols directory not found at: $symbols_dir" >&2
    return 1
  fi

  # Ensure output directory exists
  mkdir -p "$output_dir"

  # Create the zip file
  logi "Zipping native symbols..."
  (cd "$symbols_dir" && zip -r "$output_zip" . >/dev/null)

  logs "Symbols zipped into: $output_zip!"
}

# ──────────────────────────────────────────────────────────────────────────────
# Main
# ──────────────────────────────────────────────────────────────────────────────
main() {
  ensure_args "$@" || exit 1
  zip_native_symbols "$PROJECT_DIR" || exit 1
  logs "Debug symbols successfully generated"
}

# ──────────────────────────────────────────────────────────────────────────────
# Entry Point
# ──────────────────────────────────────────────────────────────────────────────
# Only run main if script is executed (not sourced)
[[ "${BASH_SOURCE[0]}" == "${0}" ]] && main "$@"
