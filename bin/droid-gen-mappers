#!/usr/bin/env bash
# Author: Bruno Guimarães
# Description:
# Version: 1.0
# Last Updated: 2026-01-04

set -euo pipefail
IFS=$'\n\t'

logi() { printf '\033[0;34m[BRLK INFO]\033[0m - %s\n' "$1"; }
logs() { printf '\033[0;32m[BRLK SUCCESS]\033[0m - %s\n' "$1"; }

# ──────────────────────────────────────────────────────────────────────────────
# Constants / Config
# ──────────────────────────────────────────────────────────────────────────────
readonly SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")/.." && pwd)"
readonly PROJECT_DIR="${1:-$(pwd)}"
readonly PKG=$(grep 'namespace' "$PROJECT_DIR/app/build.gradle.kts" | sed -E 's/.*"([^"]+)".*/\1/')
readonly PKG_DIR=$(echo "$PKG" | sed 's/\./\//g')
readonly MAIN_DIR="$PROJECT_DIR/app/src/main/java/$PKG_DIR"
readonly MODELS_DIR="$MAIN_DIR/domain/models"
readonly OUTPUT_DIR="$MAIN_DIR/data/genbrlk/mappers"

# ──────────────────────────────────────────────────────────────────────────────
# Functions
# ──────────────────────────────────────────────────────────────────────────────
gen_dto_to_domain() {
  local output_dir="$1"
  local pkg="$2"
  local -n files_ref=$3
  local -n classes_ref=$4

  mkdir -p "$output_dir"

  for i in "${!classes_ref[@]}"; do
    local class="${classes_ref[$i]}"
    local file="${files_ref[$i]}"
    local props_mapped=""
    local props=()

    # Extract Kotlin props into array
    readarray -t props < <(
      sed -n 's/.*val[[:space:]]\+\([A-Za-z_][A-Za-z0-9_]*\).*/\1/p' "$file"
    )

    # Build property mappings (REAL newlines)
    for prop in "${props[@]}"; do
      printf -v props_mapped "%s    %s = this.%s,\n" "$props_mapped" "$prop" "$prop"
    done

    export pkg class props_mapped
    envsubst <"$SCRIPT_DIR/templates/android/Mapper.kt" >"$output_dir/${class}Mapper.kt"

    logi "Generated mapper: ${class}Mapper.kt"
  done
}

get_model_files(){
  local models_dir="$1"
  local -n files_ref=$2
  local -n classes_ref=$3
  
  # Collect files and class names (skip ListItem models)
  for file in "$models_dir"/*; do
    local base="${file##*/}"

    [[ "$base" == *ListItem* ]] && continue

    files_ref+=("$file")
    local name="${base%.*}"
    classes_ref+=("$name")
  done

  logi "Found files: ${files_ref[*]}"
}

# ──────────────────────────────────────────────────────────────────────────────
# Main
# ──────────────────────────────────────────────────────────────────────────────
main() {
  local files=()
  local classes=()

  get_model_files "$MODELS_DIR" files classes

  gen_dto_to_domain "$OUTPUT_DIR" "$PKG" files classes

  logs "Mappers were successfully generated"
}

# ──────────────────────────────────────────────────────────────────────────────
# Entry Point
# ──────────────────────────────────────────────────────────────────────────────
# Only run main if script is executed (not sourced)
[[ "${BASH_SOURCE[0]}" == "${0}" ]] && main "$@"
